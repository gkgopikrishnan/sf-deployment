name: Install and Test SnowSQL

on:
  push:

jobs:
  install-snowsql:
    runs-on: ubuntu-latest

    env:
      SNOWSQL_VERSION: 1.2.24
      SNOWSQL_DIR: $HOME/snowsql

    steps:
      - name: Print environment details (Debug)
        run: |
          echo "ğŸ–¥ï¸ OS Info:"
          uname -a
          echo "ğŸ”§ Current User:"
          whoami
          echo "ğŸ“ HOME Dir:"
          echo $HOME
          echo "ğŸ§ª Debug: SNOWSQL_VERSION=$SNOWSQL_VERSION"
          echo "ğŸ§ª Debug: SNOWSQL_DIR=$SNOWSQL_DIR"

      - name: Prepare directory and download SnowSQL installer
        run: |
          echo "ğŸ“‚ Creating directory $SNOWSQL_DIR..."
          mkdir -p $SNOWSQL_DIR
          
          echo "ğŸŒ Downloading SnowSQL installer..."
          DOWNLOAD_URL="https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-${SNOWSQL_VERSION}-linux_x86_64.bash"
          echo "ğŸ”— URL: $DOWNLOAD_URL"

          curl -L -v -o $SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash "$DOWNLOAD_URL"
          DOWNLOAD_STATUS=$?

          echo "ğŸ“„ Listing contents of $SNOWSQL_DIR:"
          ls -alh $SNOWSQL_DIR

          if [ $DOWNLOAD_STATUS -ne 0 ]; then
            echo "âŒ Download failed with exit code $DOWNLOAD_STATUS"
            exit 1
          fi

          echo "âœ… Download completed successfully."

          echo "ğŸ” Making installer executable..."
          chmod +x $SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash

      - name: Install SnowSQL
        run: |
          echo "ğŸ“¦ Installing SnowSQL version $SNOWSQL_VERSION..."
          echo "ğŸ“ Installation directory: $SNOWSQL_DIR"
          echo "ğŸš€ Executing installer script non-interactively..."
          
          # Prevent installer prompt using input redirection
          bash -x $SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}.bash -y -d $SNOWSQL_DIR < /dev/null
          INSTALL_STATUS=$?

          echo "ğŸ“„ Listing contents of $SNOWSQL_DIR after installation:"
          ls -alh $SNOWSQL_DIR

          if [ $INSTALL_STATUS -ne 0 ]; then
            echo "âŒ Installation failed with exit code $INSTALL_STATUS"
            exit 1
          fi

          echo "âœ… Installation completed."

      - name: Add SnowSQL to PATH
        run: |
          BIN_PATH="$SNOWSQL_DIR/snowsql-${SNOWSQL_VERSION}/bin"
          echo "ğŸ”§ Adding SnowSQL bin path to \$GITHUB_PATH: $BIN_PATH"

          if [ -d "$BIN_PATH" ]; then
            echo "$BIN_PATH" >> $GITHUB_PATH
            echo "âœ… SnowSQL bin path added to PATH."
          else
            echo "âŒ Expected bin path does not exist: $BIN_PATH"
            ls -alh $SNOWSQL_DIR
            exit 1
          fi

      - name: Verify SnowSQL installation
        run: |
          echo "ğŸ” Checking if snowsql is available in PATH..."
          which snowsql || { echo "âŒ SnowSQL binary not found in PATH"; exit 1; }

          echo "ğŸ§ª Running 'snowsql -v' to verify version:"
          snowsql -v || { echo "âŒ SnowSQL failed to run"; exit 1; }
